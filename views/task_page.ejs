<% include partials/header %>

    <div class="container">
        <nav class="breadcrumb">
            <a class="breadcrumb-item" href="javascript:history.back()">
                < Back</a> | You are currently at:
                    <a class="breadcrumb-item" href="/">Home</a> >
                    <a class="breadcrumb-item" href="/categories">Categories</a> >
                    <a class="breadcrumb-item" href="/categories/<%= task.category_id %>"><%= task.category_name %></a> >
                    <span class="breadcrumb-item active">
                        <%= task.title %>
                    </span>
        </nav>

        <div class="container">
            <div class="col-md-6" id="task">
                <div class="row">
                    <div class="col-md-12">
                        <h3><a href="/categories/<%= task.category_id %>"><%= task.category_name %></a></h3>
                        <h1>
                            <%= task.title %>
                        </h1>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <span class="label label-primary">
                            #<%= task.id %>
                        </span>
                        <% if (task.status_task === 'accepted') { %>
                            <span class="label label-success">
                                <%= task.status_task %>
                            </span>
                        <% } else if (task.status_task === 'offered') { %>
                            <span class="label label-info">
                                <%= task.status_task %>
                            </span>
                        <% } else { %>
                            <span class="label label-warning">
                                <%= task.status_task %>
                            </span>
                        <% } %>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <h3>Description:</h3>
                        <p class="description">
                            <%= task.description %>
                        </p>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <h3>Location:</h3>
                        <p class="location">
                            <%= task.location %>
                        </p>
                    </div>
                    <div class="col-md-12">
                        <h3>Starts:</h3>
                        <p class="start_dt">
                            <%= new Date(task.start_dt) %>
                        </p>
                    </div>
                    <div class="col-md-12">
                        <h3>Ends:</h3>
                        <p class="end_dt">
                            <%= new Date(task.end_dt) %>
                        </p>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <h3>Opening offer:</h3>
                        <p class="task_price">
                            $<%= task.price %>
                        </p>
                    </div>
                </div>
            </div>

            <div class="col-md-6" id="requester-info">
                <div class="row">
                    <div class="col-md-12">
                        <h3>Requester:</h3>
                        <p class="requester">
                            <% if (loggedIn && currentUser.username == task.requester) { %>
                                You!
                            <% } else { %>
                                <%= task.requester %>
                            <% } %>
                        </p>
                    </div>
                </div>

                 <!-- show any error messages -->
                <% if (typeof message != 'undefined' && message.length > 0) { %>
                    <div class="alert alert-danger alert-dismissible"><%= message %></div>
                <% } %>

                <% if (loggedIn) { %>
                    <% if (currentUser.username == task.requester) { %>
                        <a class="btn btn-warning" href="/edit/task/<%= task.id %>">Edit this task!</a>
                    <% } else if (typeof offerByUser != 'undefined') { %>
                        You have already offered!
                        <div>
                            <div id="offer_info" style="display:none">
                                <!-- Edit offer -->
                                <form action="/edit/offer/<%=task.id%>" method="POST">
                                    <div class="form-group">
                                        <div class="input-group">
                                            <span class="input-group-addon">$</span>
                                            <input type="text" name="price" class="form-control" value="<%= offerByUser.price %>">
                                            <span class="input-group-btn">
                                                <button class="btn btn-primary" type="submit">Submit!</button>
                                            </span>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        
                        <!-- Delete offer -->
                        <form action="/delete/offer/<%=task.id%>" method="POST">
                            <a class="btn btn-warning" id="offer_btn" href="#">Edit offer!</a>
                            <input type="hidden" name="task_id" value="<%=task.id%>" readonly>
                            <button class="btn btn-danger pull-right" type="button" data-toggle="modal" data-target="#confirmDelete" data-title="Delete offer" data-message="Are you sure you want to delete this offer?">
                                <i class="glyphicon glyphicon-trash"></i>
                            </button>
                        </form>
                        <!-- Modal Dialog -->
                        <div class="modal fade" id="confirmDelete" role="dialog" aria-labelledby="confirmDeleteLabel" aria-hidden="true">
                            <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
                                <h4 class="modal-title">Delete Permanently</h4>
                                </div>
                                <div class="modal-body">
                                <p>Are you sure about this?</p>
                                </div>
                                <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-danger" id="confirm">Delete</button>
                                </div>
                            </div>
                            </div>
                        </div>
                    <% } else { %>
                        <form action="/new/offer/<%=task.id%>" method="POST">
                            <div class="form-group">
                                <div id="offer_info" style="display:none;" class="input-group">
                                    <span class="input-group-addon">$</span>
                                    <input type="text" name="price" class="form-control" placeholder="<%= task.price %>">
                                    <span class="input-group-btn">
                                        <button class="btn btn-primary" type="submit">Submit!</button>
                                    </span>
                                </div>
                            </div>
                        </form>
                        <a class="btn btn-info" id="offer_btn" href="#">Offer to help!</a>
                    <% } } %>
                    <div class="row">
                        <div class="col-md-12">
                            <h3>Current offers:</h3>
                            <!-- Display success message -->
                            <% if (typeof offer_success != 'undefined' && offer_success.length > 0) { %>
                                <div class="alert alert-success alert-dismissible"><%= offer_success %></div>
                            <% } %>
                            <p class="offers">
                                <% if (!loggedIn) { %>
                                    <a class="btn btn-info" href="/login">Login to offer!</a>
                                    <a href="/signup">Or sign up now!</a>
                                <% } %>
                            
                            <% if (offers.length == 0) { %>
                                <p>None :(</p>
                            <% } else { %> 
                                <% offers.forEach(function(offer) { %> 
                                        <div class="panel panel-default">
                                            <div class="panel-body">
                                        <% if (loggedIn && currentUser.username == offer.assignee) { %>
                                            You offered $<%= offer.price %> at <%= new Date(offer.offered_dt + 'Z') %>
                                        <% } else { %>
                                            <%= offer.assignee %> offered $<%= offer.price %> at <%= new Date(offer.offered_dt + 'Z') %>
                                        <% } %>
                                    </div>
                                        <% if (loggedIn && currentUser.username == task.requester) { %>
                                            <div class="panel-footer">
                                            <!-- Accept offer button -->
                                            <form class="form-inline" style="display: inline-block;" action="/accept/offer/<%=task.id%>" method="POST">
                                                <input type="hidden" name="task_id" value="<%=task.id%>" readonly>
                                                <input type="hidden" name="requester" value="<%=task.requester%>" readonly>
                                                <input type="hidden" name="assignee" value="<%=offer.assignee%>" readonly>
                                                <input type="hidden" name="offer_price" value="<%=offer.price%>" readonly>
                                                <input type="submit" class="btn btn-info btn-xs" value="Accept offer">
                                            </form>
                                             <!-- Reject offer button -->
                                             <form class="form-inline" style="display: inline-block;" action="/reject/offer/<%=task.id%>" method="POST">
                                                <input type="hidden" name="task_id" value="<%=task.id%>" readonly>
                                                <input type="hidden" name="requester" value="<%=task.requester%>" readonly>
                                                <input type="hidden" name="offer_id" value="<%=offer.id%>" readonly>
                                                <input type="submit" class="btn btn-danger btn-xs" value="Reject offer">
                                            </form>
                                            </div>
                                        <% } %>
                                        </div>
                                <% }); %>
                            <% } %>
                        </div>
                    </div>
            </div>
        </div>
    </div>


    <!-- Dialog show event handler -->
    <script type="text/javascript">
        $('#confirmDelete').on('show.bs.modal', function (e) {
            $message = $(e.relatedTarget).attr('data-message');
            $(this).find('.modal-body p').text($message);
            $title = $(e.relatedTarget).attr('data-title');
            $(this).find('.modal-title').text($title);
        
            // Pass form reference to modal for submission on yes/ok
            var form = $(e.relatedTarget).closest('form');
            $(this).find('.modal-footer #confirm').data('form', form);
        });
        
        // <!-- Form confirm (yes/ok) handler, submits form -->
        $('#confirmDelete').find('.modal-footer #confirm').on('click', function(){
            $(this).data('form').submit();
        });
    </script>
    <script>
        $(function () {
            $("#offer_btn").click(function () {
                $("#offer_info").toggle();
            });
        });
    </script>